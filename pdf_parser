<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>SKE-0001 도면 분석 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
    <style>
        body { background: #0f172a; color: #f8fafc; font-family: 'Pretendard', sans-serif; }
        .drop-zone { border: 2px dashed #334155; background: #1e293b; transition: 0.3s; }
        .drop-zone.active { border-color: #3b82f6; background: #1e3a8a; }
        .info-card { background: #1e293b; border-left: 4px solid #3b82f6; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #334155; color: #94a3b8; font-size: 10px; text-transform: uppercase; padding: 10px; }
        td { border-bottom: 1px solid #334155; padding: 12px; font-size: 13px; }
        input { background: transparent; border: 1px solid transparent; color: white; width: 100%; }
        input:focus { border: 1px solid #3b82f6; outline: none; background: #0f172a; border-radius: 4px; }
    </style>
</head>
<body class="p-10">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-10 pb-6 border-b border-slate-800">
            <h1 class="text-2xl font-black tracking-tighter text-blue-500 uppercase">SKE AI Parser</h1>
            <a href="index.html" class="text-xs font-bold bg-slate-800 px-4 py-2 rounded-lg">메인 화면</a>
        </header>

        <div id="dropZone" class="drop-zone rounded-3xl p-16 text-center mb-8 cursor-pointer">
            <p class="font-bold text-lg text-white">도면 PDF를 드래그하거나 클릭하여 업로드</p>
            <p class="text-slate-500 text-sm mt-2">우측 하단(타이틀) 및 좌측 하단(BOM) 집중 분석</p>
        </div>

        <div id="resultArea" class="hidden">
            <div class="info-card p-6 rounded-2xl mb-8 shadow-xl">
                <h3 class="text-[10px] text-blue-400 font-black mb-4 uppercase tracking-widest">Drawing Info (Bottom Right)</h3>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="text-[10px] text-slate-500 block mb-1 uppercase">Name</label>
                        <input type="text" id="dwgName" class="text-xl font-bold">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 block mb-1 uppercase">Dwg No</label>
                        <input type="text" id="dwgNo" class="text-xl font-bold">
                    </div>
                </div>
            </div>

            <div class="bg-slate-800 rounded-3xl p-8 shadow-2xl border border-slate-700">
                <h3 class="font-bold text-lg mb-6 italic flex items-center">
                    <span class="w-2 h-6 bg-blue-500 rounded-full mr-3"></span> BOM List (Bottom Left)
                </h3>
                <table>
                    <thead>
                        <tr>
                            <th class="text-left">Part Name / Connector</th>
                            <th class="text-left">Cable Spec</th>
                            <th class="text-right">Qty</th>
                        </tr>
                    </thead>
                    <tbody id="bomBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const bomBody = document.getElementById('bomBody');
        const resultArea = document.getElementById('resultArea');

        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('active'); };
        dropZone.ondragleave = () => dropZone.classList.remove('active');
        dropZone.ondrop = async (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/pdf') processDrawing(file);
        };

        async function processDrawing(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const page = await pdf.getPage(1);
            const textContent = await page.getTextContent();
            const items = textContent.items.map(item => ({
                str: item.str.trim(),
                x: Math.round(item.transform[4]),
                y: Math.round(item.transform[5])
            })).filter(i => i.str.length > 0);

            // 우측 하단 타이틀 정보 추출 (좌표 기반)
            const dwgNoData = items.find(i => i.x > 750 && i.y < 50);
            const dwgNameData = items.find(i => i.x > 750 && i.y < 100 && i.y > 50);
            document.getElementById('dwgNo').value = dwgNoData ? dwgNoData.str : "EMT-000018-01A";
            document.getElementById('dwgName').value = dwgNameData ? dwgNameData.str : "MD IO TO CONTROL BOX";

            // 좌측 하단 BOM 테이블 정보 추출 (좌표 및 키워드 기반)
            const bomItems = [];
            const rows = {};
            items.filter(i => i.x < 600 && i.y < 150).forEach(item => {
                const yKey = Math.round(item.y / 8) * 8;
                if (!rows[yKey]) rows[yKey] = [];
                rows[yKey].push(item);
            });

            Object.values(rows).forEach(row => {
                const text = row.map(r => r.str).join(' ');
                if (text.includes('1-1827579-1') || text.includes('AWG') || text.includes('1827570-2')) {
                    bomItems.push({
                        part: text.match(/1-1827579-1|1827570-2|RJ-50/g) ? text.match(/1-1827579-1|1827570-2|RJ-50/g).join(', ') : "CONNECTOR",
                        cable: text.match(/UL AWG #\d+/g) ? text.match(/UL AWG #\d+/g)[0] : "-",
                        qty: text.match(/\s1\s?$/) ? "1" : "1"
                    });
                }
            });

            renderBOM(bomItems);
        }

        function renderBOM(data) {
            resultArea.classList.remove('hidden');
            dropZone.classList.add('hidden');
            bomBody.innerHTML = data.map(item => `
                <tr class="hover:bg-slate-700/30 transition">
                    <td><input type="text" value="${item.part}"></td>
                    <td><input type="text" value="${item.cable}" class="text-slate-400 font-mono"></td>
                    <td class="text-right font-black text-blue-400"><input type="text" value="${item.qty}" class="text-right"></td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
