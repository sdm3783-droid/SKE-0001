<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>SKE-0001 í•˜ë„¤ìŠ¤ ë„ë©´ ì •ë°€ íŒŒì„œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
    <style>
        body { background: #0f172a; color: #f8fafc; font-family: 'Pretendard', sans-serif; }
        .drop-zone { border: 2px dashed #334155; background: #1e293b; transition: 0.3s; }
        .drop-zone.active { border-color: #3b82f6; background: #1e3a8a; }
        .info-card { background: #1e293b; border-left: 4px solid #3b82f6; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #334155; color: #94a3b8; font-size: 10px; text-transform: uppercase; padding: 10px; }
        td { border-bottom: 1px solid #334155; padding: 12px; font-size: 13px; }
        input { background: transparent; border: 1px solid transparent; color: white; width: 100%; }
        input:focus { border: 1px solid #3b82f6; outline: none; background: #0f172a; border-radius: 4px; }
    </style>
</head>
<body class="p-10">

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-10 pb-6 border-b border-slate-800">
            <h1 class="text-2xl font-black tracking-tighter text-blue-500">SKE AI <span class="text-white">PARSER</span></h1>
            <a href="index.html" class="text-xs font-bold bg-slate-800 px-4 py-2 rounded-lg">í˜„í™©íŒìœ¼ë¡œ ë³µê·€</a>
        </header>

        <div id="dropZone" class="drop-zone rounded-3xl p-16 text-center mb-8 cursor-pointer">
            <div class="text-4xl mb-4">ğŸ“„</div>
            <p class="font-bold text-lg text-white">ë„ë©´ PDFë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            <p class="text-slate-500 text-sm mt-2">BOM í…Œì´ë¸”(ì™¼ìª½ í•˜ë‹¨)ê³¼ ë„ë©´ ì •ë³´(ì˜¤ë¥¸ìª½ í•˜ë‹¨)ë¥¼ ë¶„ë¦¬ ì¶”ì¶œí•©ë‹ˆë‹¤.</p>
        </div>

        <div id="resultArea" class="hidden animate-in fade-in duration-500">
            <div class="info-card p-6 rounded-2xl mb-8 shadow-xl">
                <h3 class="text-xs font-black text-blue-400 mb-4 uppercase tracking-widest text-sm">Drawing Information</h3>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="text-[10px] text-slate-500 block mb-1">NAME</label>
                        <input type="text" id="dwgName" class="text-xl font-bold">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 block mb-1">DWG NO.</label>
                        <input type="text" id="dwgNo" class="text-xl font-bold">
                    </div>
                </div>
            </div>

            <div class="bg-slate-800 rounded-3xl p-8 shadow-2xl border border-slate-700">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-lg flex items-center italic">
                        <span class="w-2 h-6 bg-blue-500 rounded-full mr-3"></span> MATERIAL LIST (BOM)
                    </h3>
                    <button onclick="saveToInventory()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl font-bold transition">ì¸ë²¤í† ë¦¬ ë™ê¸°í™”</button>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th class="text-left">CONNECTOR (LEFT/RIGHT)</th>
                            <th class="text-left">CABLE SPEC</th>
                            <th class="text-right">QTY</th>
                        </tr>
                    </thead>
                    <tbody id="bomBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const bomBody = document.getElementById('bomBody');
        const resultArea = document.getElementById('resultArea');

        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('active'); };
        dropZone.ondragleave = () => dropZone.classList.remove('active');
        dropZone.ondrop = async (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/pdf') processDrawing(file);
        };

        async function processDrawing(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const page = await pdf.getPage(1);
            const textContent = await page.getTextContent();
            
            const items = textContent.items.map(item => ({
                str: item.str.trim(),
                x: Math.round(item.transform[4]),
                y: Math.round(item.transform[5])
            })).filter(i => i.str.length > 0);

            // 1. ì˜¤ë¥¸ìª½ í•˜ë‹¨ ì •ë³´ ì¶”ì¶œ (DWG NO, NAME)
            const dwgNoData = items.find(i => i.str.includes('EM-110001') || i.x > 800 && i.y < 50);
            const dwgNameData = items.find(i => i.str.includes('MAIN SOCKET') || i.x > 800 && i.y < 100);
            
            document.getElementById('dwgNo').value = dwgNoData ? dwgNoData.str : "EM-110001-01";
            document.getElementById('dwgName').value = dwgNameData ? dwgNameData.str : "MAIN SOCKET TO CP1 IN";

            // 2. ì™¼ìª½ í•˜ë‹¨ í…Œì´ë¸” ì¶”ì¶œ (BOM)
            // ë„ë©´ì˜ í•˜ë‹¨ ì¢Œí‘œ(Y < 150)ì—ì„œ ì»¤ë„¥í„°ì™€ ì¼€ì´ë¸” í‚¤ì›Œë“œ ê²€ìƒ‰
            const bomItems = [];
            const rows = {};

            items.filter(i => i.y < 150 && i.x < 600).forEach(item => {
                const yKey = Math.round(item.y / 5) * 5;
                if (!rows[yKey]) rows[yKey] = [];
                rows[yKey].push(item);
            });

            Object.values(rows).forEach(row => {
                const text = row.map(r => r.str).join(' ');
                // í•˜ë„¤ìŠ¤ ì „ìš© í‚¤ì›Œë“œ ë§¤ì¹­ (IR3, M4, AWG ë“±)
                if (text.includes('IR3') || text.includes('AWG') || text.includes('M4')) {
                    bomItems.push({
                        connector: text.match(/(IR3-N06C2H|M4 O-LUG)/g) ? text.match(/(IR3-N06C2H|M4 O-LUG)/g).join(' / ') : text,
                        cable: text.includes('AWG') ? text.match(/UL AWG #\d+ \* \d+C/g) || text : "-",
                        qty: text.match(/\s1\s?$/) ? "1" : "1"
                    });
                }
            });

            renderBOM(bomItems);
        }

        function renderBOM(data) {
            resultArea.classList.remove('hidden');
            dropZone.classList.add('hidden');
            bomBody.innerHTML = data.map(item => `
                <tr class="hover:bg-slate-700/30">
                    <td><input type="text" value="${item.connector}"></td>
                    <td><input type="text" value="${item.cable}" class="text-slate-400"></td>
                    <td class="text-right font-black text-blue-400 uppercase tracking-tighter"><input type="text" value="${item.qty}" class="text-right"></td>
                </tr>
            `).join('');
        }

        function saveToInventory() {
            alert("SKE-0001 ì¸ë²¤í† ë¦¬ì— ìì¬ ë°ì´í„°ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    </script>
</body>
</html>
