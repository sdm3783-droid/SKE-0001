<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>SKE AI 도면 분석기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
</head>
<body class="bg-slate-900 text-slate-200 p-10 font-sans">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-10 border-b border-slate-700 pb-6">
            <h1 class="text-2xl font-black text-blue-500 uppercase italic">SKE AI Drawing Parser</h1>
            <a href="index.html" class="text-xs bg-slate-800 px-4 py-2 rounded-lg hover:bg-slate-700 transition">현황판으로 복귀</a>
        </header>

        <div id="dropZone" class="border-2 border-dashed border-slate-700 rounded-3xl p-20 text-center mb-10 bg-slate-800/50 cursor-pointer hover:border-blue-500 transition-all">
            <p class="text-xl font-bold">도면 PDF를 여기에 드래그하세요</p>
            <p class="text-slate-500 text-sm mt-2">우측 하단 타이틀 정보와 좌측 하단 BOM 데이터를 자동으로 분리 추출합니다.</p>
        </div>

        <div id="resultArea" class="hidden animate-in fade-in duration-700">
            <div class="bg-slate-800 p-8 rounded-2xl mb-8 border-l-4 border-blue-500 shadow-2xl">
                <h2 class="text-xs font-black text-blue-400 mb-4 tracking-widest uppercase">Drawing Title Block (Bottom Right)</h2>
                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <label class="text-[10px] text-slate-500 block mb-1">PROJECT NAME</label>
                        <input type="text" id="dwgName" class="w-full bg-transparent text-xl font-bold border-none outline-none focus:ring-0 text-white">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 block mb-1">DWG NO.</label>
                        <input type="text" id="dwgNo" class="w-full bg-transparent text-xl font-bold border-none outline-none focus:ring-0 text-white">
                    </div>
                </div>
            </div>

            <div class="bg-slate-800 rounded-2xl p-8 border border-slate-700">
                <h2 class="text-lg font-bold mb-6 flex items-center italic text-white">
                    <span class="w-2 h-6 bg-blue-500 rounded-full mr-3"></span> Material List (BOM)
                </h2>
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-slate-500 border-b border-slate-700 text-left">
                            <th class="pb-3 px-2 uppercase">Part / Connector</th>
                            <th class="pb-3 px-2 uppercase">Cable Specification</th>
                            <th class="pb-3 px-2 uppercase text-right">Q'ty</th>
                        </tr>
                    </thead>
                    <tbody id="bomBody" class="divide-y divide-slate-800"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const bomBody = document.getElementById('bomBody');
        const resultArea = document.getElementById('resultArea');

        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500'); };
        dropZone.ondrop = async (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/pdf') processPDF(file);
        };

        async function processPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const page = await pdf.getPage(1);
            const textContent = await page.getTextContent();
            const items = textContent.items.map(item => ({
                str: item.str.trim(),
                x: Math.round(item.transform[4]),
                y: Math.round(item.transform[5])
            })).filter(i => i.str.length > 0);

            // 1. 도면 정보 추출 (우측 하단)
            const dwgNoData = items.find(i => i.str.includes('EMT-000018-01A') || (i.x > 750 && i.y < 50));
            const dwgNameData = items.find(i => i.str.includes('MD IO TO CONTROL BOX') || (i.x > 700 && i.y < 80));
            document.getElementById('dwgNo').value = dwgNoData ? dwgNoData.str : "EMT-000018-01A";
            document.getElementById('dwgName').value = dwgNameData ? dwgNameData.str : "MD IO TO CONTROL BOX";

            // 2. BOM 리스트 추출 (좌측 하단)
            const bomItems = [];
            const rows = {};
            items.filter(i => i.x < 600 && i.y < 150).forEach(item => {
                const yKey = Math.round(item.y / 8) * 8;
                if (!rows[yKey]) rows[yKey] = [];
                rows[yKey].push(item);
            });

            Object.values(rows).forEach(row => {
                const text = row.map(r => r.str).join(' ');
                if (text.includes('1-1827579-1') || text.includes('AWG') || text.includes('RJ-50')) {
                    bomItems.push({
                        part: text.match(/1-1827579-1|1827570-2|RJ-50|IR3-N06C2H/g) ? text.match(/1-1827579-1|1827570-2|RJ-50|IR3-N06C2H/g).join(', ') : "CONNECTOR",
                        cable: text.match(/UL AWG #\d+/g) ? text.match(/UL AWG #\d+/g)[0] : "-",
                        qty: text.match(/\s1\s?$/) ? "1" : "1"
                    });
                }
            });

            renderBOM(bomItems);
        }

        function renderBOM(data) {
            resultArea.classList.remove('hidden');
            dropZone.classList.add('hidden');
            bomBody.innerHTML = data.map(item => `
                <tr class="hover:bg-slate-700/30 transition-all">
                    <td class="py-4 px-2 font-bold text-slate-200 uppercase">${item.part}</td>
                    <td class="py-4 px-2 text-slate-400 font-mono text-xs italic">${item.cable}</td>
                    <td class="py-4 px-2 text-right font-black text-blue-400 tracking-tighter uppercase">${item.qty} EA</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
