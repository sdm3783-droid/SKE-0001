<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹ ê´‘ì „ì ì‹¤ì‹œê°„ í†µí•©ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        :root { --primary: #1e40af; --bg: #f1f5f9; --warn: #dc2626; --part: #d97706; --success: #059669; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); padding: 20px; color: #1e293b; }
        .container { max-width: 1700px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { margin-top: 10px; color: var(--primary); border-left: 6px solid var(--primary); padding-left: 15px; margin-bottom: 20px; font-weight: 800; }
        
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; background: #f8fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        input { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-add { background: var(--primary); color: white; grid-column: 1 / -1; }
        .btn-excel { background: #059669; color: white; float: right; }

        .search-container { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; background: #eff6ff; padding: 15px; border-radius: 8px; border: 1px solid #dbeafe; }
        .search-input { padding: 8px; width: 180px; border: 1px solid #cbd5e1; border-radius: 6px; }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 12px; font-size: 12px; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; text-align: center; font-size: 13px; }
        .editable:hover { background: #fff9c4; cursor: pointer; }
        .btn-copy { background: #e2e8f0; color: #475569; padding: 2px 6px; font-size: 10px; margin-left: 5px; border-radius: 4px; border: 1px solid #cbd5e1; cursor: pointer; }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <img src="logo.png" alt="SKE ë¡œê³ " style="height: 60px; display: block; margin-bottom: 10px; margin-left: 20px;">
    
    <h2>ğŸ“Š ì‹ ê´‘ì „ì ì‹¤ì‹œê°„ í†µí•©ê´€ë¦¬ ì‹œìŠ¤í…œ <span id="syncStatus" style="font-size:12px; color:var(--success);">â— ì‹¤ì‹œê°„ ì—°ê²°ë¨</span></h2>

    <div class="input-section">
        <div class="input-grid">
            <input type="date" id="pRegDate">
            <input type="text" id="pName" placeholder="í”„ë¡œì íŠ¸ëª…">
            <input type="text" id="pOrder" placeholder="ë°œì£¼ë²ˆí˜¸">
            <input type="text" id="pVendor" placeholder="ì—…ì²´ëª…">
            <input type="text" id="pItem" placeholder="ìì¬ëª…">
            <input type="number" id="pTargetQty" placeholder="í•„ìš”">
            <input type="number" id="pInQty" value="0">
            <input type="text" id="pRemark" placeholder="ë¹„ê³ ">
            <button class="btn btn-add" onclick="addItem()">ì‹¤ì‹œê°„ ê³µìœ  ë“±ë¡</button>
        </div>
    </div>

    <div class="search-container">
        <div><label style="font-size:12px; font-weight:bold;">ğŸ¢ ì—…ì²´ëª… ê²€ìƒ‰: </label><input type="text" id="searchVendor" onkeyup="render()" class="search-input"></div>
        <div><label style="font-size:12px; font-weight:bold;">ğŸ” í”„ë¡œì íŠ¸/ìì¬ ê²€ìƒ‰: </label><input type="text" id="searchItem" onkeyup="render()" class="search-input"></div>
        <div style="flex-grow: 1;"><button class="btn btn-excel" onclick="exportCSV()">ì—‘ì…€ ì €ì¥</button></div>
    </div>

    <table>
        <thead>
            <tr>
                <th>ë“±ë¡ì¼ì</th>
                <th>í”„ë¡œì íŠ¸ëª… (ë³µì‚¬)</th>
                <th>ë°œì£¼ë²ˆí˜¸</th>
                <th>ì—…ì²´ëª…</th>
                <th>ìì¬ëª…</th>
                <th>í•„ìš”</th>
                <th>ì…ê³ </th>
                <th>ì”ì—¬</th>
                <th>ìƒíƒœ</th>
                <th>ë¹„ê³ </th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    const DATABASE_URL = "https://ske-0001-default-rtdb.firebaseio.com/"; 
    const DB_PATH = DATABASE_URL + "inventory.json";

    let inventory = [];

    async function loadData() {
        try {
            const res = await fetch(DB_PATH);
            const data = await res.json();
            inventory = data ? Object.values(data) : [];
            render();
            document.getElementById('syncStatus').innerText = "â— ì‹¤ì‹œê°„ ì—°ê²°ë¨";
        } catch(e) { document.getElementById('syncStatus').innerText = "â—‹ ì—°ê²° ì˜¤ë¥˜"; }
    }

    async function saveData() {
        await fetch(DB_PATH, { method: 'PUT', body: JSON.stringify(inventory) });
        render();
    }

    function render() {
        const body = document.getElementById('tableBody');
        const vFilter = document.getElementById('searchVendor').value.toLowerCase();
        const iFilter = document.getElementById('searchItem').value.toLowerCase();
        body.innerHTML = '';
        
        const sorted = [...inventory].sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

        sorted.forEach((item) => {
            const originIdx = inventory.indexOf(item);
            if(item.vendor.toLowerCase().includes(vFilter) && (item.item.toLowerCase().includes(iFilter) || item.project.toLowerCase().includes(iFilter))) {
                const rem = item.targetQty - item.inQty;
                const statusText = rem <= 0 ? 'ì™„ë£Œ' : (item.inQty > 0 ? 'ë¶€ë¶„ì…ê³ ' : 'ë¯¸ì…ê³ ');
                const statusColor = rem <= 0 ? '#dcfce7' : (item.inQty > 0 ? '#fef3c7' : '#fee2e2');
                const textColor = rem <= 0 ? '#166534' : (item.inQty > 0 ? '#92400e' : '#991b1b');

                body.innerHTML += `
                    <tr>
                        <td>${item.regDate}</td>
                        <td style="text-align:left; padding-left:10px;">
                            <span class="editable" onclick="editCell(${originIdx}, 'project', this)">${item.project}</span>
                            <button class="btn-copy" onclick="copyRow(${originIdx})">ë³µì‚¬</button>
                        </td>
                        <td>${item.order}</td>
                        <td>${item.vendor}</td>
                        <td class="editable" onclick="editCell(${originIdx}, 'item', this)">${item.item}</td>
                        <td class="editable" onclick="editCell(${originIdx}, 'targetQty', this)">${item.targetQty}</td>
                        <td class="editable" onclick="editCell(${originIdx}, 'inQty', this)" style="color:var(--primary); font-weight:bold;">${item.inQty}</td>
                        <td style="color:red; font-weight:bold;">${rem > 0 ? rem : '-'}</td>
                        <td><span class="status-badge" style="background:${statusColor}; color:${textColor};">${statusText}</span></td>
                        <td class="editable" onclick="editCell(${originIdx}, 'remark', this)">${item.remark || '-'}</td>
                        <td><button onclick="deleteItem(${originIdx})" style="cursor:pointer; background:none; border:none;">âŒ</button></td>
                    </tr>`;
            }
        });
    }

    async function addItem() {
        const item = {
            regDate: document.getElementById('pRegDate').value,
            project: document.getElementById('pName').value,
            order: document.getElementById('pOrder').value,
            vendor: document.getElementById('pVendor').value,
            item: document.getElementById('pItem').value,
            targetQty: parseInt(document.getElementById('pTargetQty').value) || 0,
            inQty: parseInt(document.getElementById('pInQty').value) || 0,
            remark: document.getElementById('pRemark').value,
            timestamp: Date.now()
        };
        if(!item.project || !item.item) return alert("í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        inventory.push(item);
        await saveData();
        document.getElementById('pItem').value = '';
    }

    function editCell(idx, field, el) {
        if(el.querySelector('input')) return;
        const val = inventory[idx][field];
        el.innerHTML = `<input type="text" style="width:90%" value="${val}" onblur="updateVal(${idx}, '${field}', this.value)">`;
        el.querySelector('input').focus();
    }

    async function updateVal(idx, field, val) {
        inventory[idx][field] = field.includes('Qty') ? parseInt(val) : val;
        await saveData();
    }

    function copyRow(idx) {
        const item = inventory[idx];
        document.getElementById('pName').value = item.project;
        document.getElementById('pOrder').value = item.order;
        document.getElementById('pVendor').value = item.vendor;
        document.getElementById('pItem').value = item.item;
        document.getElementById('pTargetQty').value = item.targetQty;
    }

    async function deleteItem(idx) { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { inventory.splice(idx, 1); await saveData(); } }

    function exportCSV() {
        let csv = "\uFEFFë“±ë¡ì¼ì,í”„ë¡œì íŠ¸,ë°œì£¼ë²ˆí˜¸,ì—…ì²´ëª…,ìì¬ëª…,í•„ìš”ìˆ˜ëŸ‰,ì…ê³ ìˆ˜ëŸ‰,ì”ì—¬,ìƒíƒœ,ë¹„ê³ \n";
        inventory.forEach(item => {
            const rem = item.targetQty - item.inQty;
            csv += `"${item.regDate}","${item.project}","${item.order}","${item.vendor}","${item.item}",${item.targetQty},${item.inQty},${rem},"${rem<=0?'ì™„ë£Œ':'ë¯¸ì…ê³ '}","${item.remark}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `ì‹ ê´‘ì „ì_ìì¬í˜„í™©.csv`;
        a.click();
    }
    
    document.getElementById('pRegDate').value = new Date().toISOString().split('T')[0];
    loadData();
    setInterval(loadData, 5000);
</script>
</body>
</html>
