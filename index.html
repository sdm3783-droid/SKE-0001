<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‚¬ê¸‰ìì¬ ê´€ë¦¬ ì‹œìŠ¤í…œ (ë””ìì¸ ê°œì„ )</title>
    <style>
        :root { --primary: #1e40af; --bg: #f1f5f9; --warn: #dc2626; --part: #d97706; --success: #059669; --delay-bg: #fff7ed; --delay-border: #fb923c; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); padding: 20px; color: #1e293b; }
        .container { max-width: 1700px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: var(--primary); border-left: 6px solid var(--primary); padding-left: 15px; margin-bottom: 20px; }
        
        /* ì—…ì²´ë³„ ëŒ€ì‹œë³´ë“œ - ë””ìì¸ ëŒ€í­ ìˆ˜ì • */
        .dashboard { display: flex; gap: 15px; overflow-x: auto; padding: 10px 5px; margin-bottom: 25px; border-bottom: 2px solid #f1f5f9; }
        .dash-card { min-width: 280px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; cursor: pointer; transition: 0.3s; position: relative; display: flex; flex-direction: column; gap: 10px; }
        .dash-card:hover { transform: translateY(-5px); border-color: var(--primary); background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        
        .dash-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .dash-vendor-tag { font-size: 10px; font-weight: bold; color: white; background: var(--primary); padding: 2px 8px; border-radius: 4px; }
        
        /* ë²„íŠ¼ ìœ„ì¹˜ ë° ìŠ¤íƒ€ì¼ ê°œì„  */
        .btn-mail { background: #ef4444; color: white; border: none; padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 4px; border: 1px solid transparent; }
        .btn-mail:hover { background: white; color: #ef4444; border-color: #ef4444; }

        .dash-title { font-size: 17px; font-weight: 800; color: #1e293b; margin: 0; }
        
        .dash-stats-row { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
        .dash-info { font-size: 13px; color: #64748b; font-weight: 500; }
        .dash-percent { font-size: 20px; font-weight: 900; color: var(--primary); }
        
        .dash-progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .dash-progress-fill { height: 100%; background: var(--primary); transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .delay-tag { font-size: 11px; color: var(--warn); font-weight: bold; background: #fee2e2; padding: 2px 8px; border-radius: 15px; border: 1px solid #fecaca; display: inline-block; }

        /* í…Œì´ë¸” ë° ì…ë ¥ë¶€ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; background: #f8fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .field { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 11px; font-weight: bold; color: #64748b; }
        input, select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-add { background: var(--primary); color: white; grid-column: 1 / -1; }
        .btn-excel { background: #059669; color: white; }
        .btn-delete { background: none; color: #94a3b8; font-size: 11px; }
        .btn-copy { background: #e2e8f0; color: #475569; padding: 2px 6px; font-size: 10px; margin-left: 5px; border-radius: 4px; border: 1px solid #cbd5e1; }
        .search-container { display: flex; gap: 15px; align-items: center; margin-bottom: 15px; background: #eff6ff; padding: 15px; border-radius: 8px; border: 1px solid #dbeafe; }
        .search-input { padding: 8px; width: 150px; border: 1px solid #cbd5e1; border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; color: #475569; padding: 12px 10px; font-size: 12px; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 10; }
        td { padding: 12px 10px; border-bottom: 1px solid #f1f5f9; text-align: center; font-size: 13px; }
        .tr-delay { background-color: var(--delay-bg) !important; border-left: 4px solid var(--delay-border); }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; }
        .status-none { background: #fee2e2; color: #991b1b; }
        .status-part { background: #fef3c7; color: #92400e; }
        .status-full { background: #dcfce7; color: #166534; }
        .status-delay { background: var(--warn); color: white; border-radius: 4px; padding: 2px 5px; margin-right: 4px; font-size: 10px; }
        .editable { cursor: pointer; border-radius: 4px; padding: 2px 5px; }
        .editable:hover { background: #fff9c4; }
        .edit-input { width: 90%; padding: 4px; border: 2px solid var(--primary); border-radius: 4px; text-align: center; font-size: 13px; }
        #syncStatus { font-size: 12px; color: var(--success); margin-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ¢ ì‚¬ê¸‰ìì¬ ê´€ë¦¬ ì‹œìŠ¤í…œ <span id="syncStatus">â— ì—°ê²° í™•ì¸ ì¤‘...</span></h2>

    <div id="dashboard" class="dashboard"></div>

    <div class="input-section">
        <div class="input-grid">
            <div class="field"><label>ë“±ë¡ì¼ì</label><input type="date" id="pRegDate"></div>
            <div class="field"><label>í”„ë¡œì íŠ¸ëª…</label><input type="text" id="pName" placeholder="í”„ë¡œì íŠ¸ëª…"></div>
            <div class="field"><label>ë°œì£¼ë²ˆí˜¸</label><input type="text" id="pOrder" placeholder="ë°œì£¼ë²ˆí˜¸"></div>
            <div class="field"><label>ì—…ì²´ëª…</label><input type="text" id="pVendor" placeholder="ì—…ì²´ëª…"></div>
            <div class="field"><label>ìì¬ëª…</label><input type="text" id="pItem" placeholder="ìì¬ëª…"></div>
            <div class="field"><label>í•„ìš”ìˆ˜ëŸ‰</label><input type="number" id="pTargetQty" value="1"></div>
            <div class="field"><label>ì…ê³ ìˆ˜ëŸ‰</label><input type="number" id="pInQty" value="0"></div>
            <div class="field"><label>ë¹„ê³ </label><input type="text" id="pRemark" placeholder="ë¹„ê³ "></div>
            <button class="btn btn-add" onclick="addItem()">ì €ì¥ ë° í´ë¼ìš°ë“œ ë™ê¸°í™”</button>
        </div>
    </div>

    <div class="search-container">
        <div class="search-box"><label>ğŸ“… ê¸°ê°„</label><select id="filterYear" onchange="render()" class="search-input"></select><select id="filterMonth" onchange="render()" class="search-input"><option value="all">ì „ì²´ ì›”</option><option value="01">1ì›”</option><option value="02">2ì›”</option><option value="03">3ì›”</option><option value="04">4ì›”</option><option value="05">5ì›”</option><option value="06">6ì›”</option><option value="07">7ì›”</option><option value="08">8ì›”</option><option value="09">9ì›”</option><option value="10">10ì›”</option><option value="11">11ì›”</option><option value="12">12ì›”</option></select></div>
        <div class="search-box"><label>ğŸ¢ ì—…ì²´</label><input type="text" id="searchVendor" onkeyup="render()" class="search-input"></div>
        <div class="search-box"><label>ğŸ” ê²€ìƒ‰</label><input type="text" id="searchItem" onkeyup="render()" class="search-input"></div>
        <div style="flex-grow: 1; text-align: right;"><button class="btn btn-excel" onclick="exportCSV()">ì—‘ì…€ ì €ì¥</button></div>
    </div>

    <table>
        <thead>
            <tr><th>ë“±ë¡ì¼ì</th><th>í”„ë¡œì íŠ¸ëª…</th><th>ë°œì£¼ë²ˆí˜¸</th><th>ì—…ì²´ëª…</th><th>ìì¬ëª…</th><th>í•„ìš”</th><th>ì…ê³ </th><th>ì”ì—¬</th><th>ìƒíƒœ</th><th>ë¹„ê³ </th><th>ê´€ë¦¬</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    const DATABASE_URL = "https://ske-0001-default-rtdb.firebaseio.com/"; 
    const DB_PATH = DATABASE_URL + "inventory.json";
    let inventory = [];

    document.getElementById('pRegDate').value = new Date().toISOString().split('T')[0];

    async function loadData() {
        try {
            const response = await fetch(DB_PATH);
            const data = await response.json();
            inventory = data ? Object.values(data) : [];
            updateFilterOptions();
            updateDashboard();
            render();
            document.getElementById('syncStatus').innerText = "â— ë™ê¸°í™” ì™„ë£Œ";
        } catch (e) { document.getElementById('syncStatus').innerText = "â—‹ ì˜¤í”„ë¼ì¸"; }
    }

    function getDaysDiff(regDate) {
        const today = new Date();
        const start = new Date(regDate);
        return Math.floor((today - start) / (1000 * 60 * 60 * 24));
    }

    function sendGmail(vName, event) {
        event.stopPropagation();
        const delayedItems = inventory.filter(item => item.vendor === vName && (item.targetQty - item.inQty > 0) && getDaysDiff(item.regDate) >= 7);
        if (delayedItems.length === 0) return alert("ì§€ì—° í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
        let itemList = delayedItems.map(item => `- ${item.project} / ${item.item} (ì”ì—¬:${item.targetQty-item.inQty})`).join('%0A');
        const subject = encodeURIComponent(`[ë…ì´‰] ${vName} ì‚¬ê¸‰ìì¬ ì…ê³  ì§€ì—° ì•ˆë‚´`);
        const body = encodeURIComponent(`ì•ˆë…•í•˜ì„¸ìš”, ${vName} ë‹´ë‹¹ìë‹˜.\n\nì•„ë˜ í’ˆëª©ë“¤ì´ 7ì¼ ì´ìƒ ì§€ì—°ë˜ê³  ìˆìŠµë‹ˆë‹¤. í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤.\n\n[ì§€ì—° ë¦¬ìŠ¤íŠ¸]\n${itemList}\n\nê°ì‚¬í•©ë‹ˆë‹¤.`);
        window.open(`https://mail.google.com/mail/?view=cm&fs=1&su=${subject}&body=${body}`, '_blank');
    }

    function updateDashboard() {
        const dash = document.getElementById('dashboard');
        const vendorMap = {};
        inventory.forEach(item => {
            if (!vendorMap[item.vendor]) vendorMap[item.vendor] = { total: 0, completed: 0, delayCount: 0 };
            vendorMap[item.vendor].total++;
            if (item.targetQty > 0 && item.inQty >= item.targetQty) vendorMap[item.vendor].completed++;
            else if (getDaysDiff(item.regDate) >= 7) vendorMap[item.vendor].delayCount++;
        });

        dash.innerHTML = '';
        Object.keys(vendorMap).sort().forEach(vName => {
            const info = vendorMap[vName];
            const percent = Math.round((info.completed / info.total) * 100);
            const delayHtml = info.delayCount > 0 ? `<span class="delay-tag">ì§€ì—° ${info.delayCount}ê±´</span>` : '';
            const mailBtnHtml = info.delayCount > 0 ? `<button class="btn-mail" onclick="sendGmail('${vName}', event)">Gmail ë…ì´‰</button>` : '';
            
            dash.innerHTML += `
                <div class="dash-card" onclick="filterByVendor('${vName}')">
                    <div class="dash-header">
                        <span class="dash-vendor-tag">VENDOR</span>
                        ${mailBtnHtml}
                    </div>
                    <div class="dash-title">${vName}</div>
                    <div style="margin-top:5px;">${delayHtml}</div>
                    <div class="dash-stats-row">
                        <div class="dash-info">ì™„ë£Œ ${info.completed} / ì „ì²´ ${info.total}</div>
                        <div class="dash-percent">${percent}%</div>
                    </div>
                    <div class="dash-progress-bar">
                        <div class="dash-progress-fill" style="width: ${percent}%; background: ${percent===100?'var(--success)':'var(--primary)'}"></div>
                    </div>
                </div>
            `;
        });
    }

    function filterByVendor(vName) { document.getElementById('searchVendor').value = vName; render(); }
    function updateFilterOptions() {
        const yearSelect = document.getElementById('filterYear');
        const years = [...new Set(inventory.map(item => item.regDate.split('-')[0]))];
        if (years.length === 0) years.push(new Date().getFullYear().toString());
        years.sort((a, b) => b - a);
        const currentYear = new Date().getFullYear().toString();
        yearSelect.innerHTML = '<option value="all">ì „ì²´ ì—°ë„</option>';
        years.forEach(y => { yearSelect.innerHTML += `<option value="${y}">${y}ë…„</option>`; });
        yearSelect.value = currentYear;
    }

    async function saveData() { await fetch(DB_PATH, { method: 'PUT', body: JSON.stringify(inventory) }); loadData(); }
    async function addItem() {
        const item = { regDate: document.getElementById('pRegDate').value, project: document.getElementById('pName').value, order: document.getElementById('pOrder').value, vendor: document.getElementById('pVendor').value, item: document.getElementById('pItem').value, targetQty: parseInt(document.getElementById('pTargetQty').value) || 0, inQty: parseInt(document.getElementById('pInQty').value) || 0, remark: document.getElementById('pRemark').value, timestamp: Date.now() };
        if(!item.vendor || !item.item) return alert("í•­ëª© ì…ë ¥ ëˆ„ë½");
        inventory.push(item); await saveData(); document.getElementById('pItem').value = '';
    }

    function editCell(idx, field, element) {
        if (element.querySelector('input')) return;
        const input = document.createElement('input');
        input.type = field.includes('Qty') ? 'number' : (field === 'regDate' ? 'date' : 'text');
        input.value = inventory[idx][field];
        input.className = 'edit-input';
        element.innerHTML = ''; element.appendChild(input); input.focus();
        input.onblur = async function() { inventory[idx][field] = field.includes('Qty') ? (parseInt(input.value) || 0) : input.value; await saveData(); };
    }

    function copyRow(idx) {
        const item = inventory[idx];
        document.getElementById('pRegDate').value = item.regDate; document.getElementById('pName').value = item.project; document.getElementById('pOrder').value = item.order; document.getElementById('pVendor').value = item.vendor; document.getElementById('pItem').value = item.item; document.getElementById('pTargetQty').value = item.targetQty; document.getElementById('pInQty').value = 0; document.getElementById('pRemark').value = item.remark || ""; window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function render() {
        const body = document.getElementById('tableBody');
        const vFilter = document.getElementById('searchVendor').value.toLowerCase();
        const iFilter = document.getElementById('searchItem').value.toLowerCase();
        const yFilter = document.getElementById('filterYear').value;
        const mFilter = document.getElementById('filterMonth').value;
        body.innerHTML = '';
        const sortedList = [...inventory].sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
        sortedList.forEach((item) => {
            const originalIdx = inventory.indexOf(item);
            const [y, m] = item.regDate.split('-');
            if((yFilter === 'all' || y === yFilter) && (mFilter === 'all' || m === mFilter) && item.vendor.toLowerCase().includes(vFilter) && (item.item.toLowerCase().includes(iFilter) || item.project.toLowerCase().includes(iFilter))) {
                const rem = item.targetQty - item.inQty;
                const isDelayed = (rem > 0 && getDaysDiff(item.regDate) >= 7);
                const statusText = item.inQty === 0 ? 'ë¯¸ì…ê³ ' : (rem > 0 ? `ë¶€ë¶„(${rem})` : 'ì™„ë£Œ');
                const statusClass = item.inQty === 0 ? 'status-none' : (rem > 0 ? 'status-part' : 'status-full');
                body.innerHTML += `<tr class="${isDelayed ? 'tr-delay' : ''}"><td class="editable" onclick="editCell(${originalIdx}, 'regDate', this)">${item.regDate}</td><td style="text-align:left; padding-left:15px;"><span class="editable" onclick="editCell(${originalIdx}, 'project', this)">${item.project}</span><button class="btn-copy" onclick="copyRow(${originalIdx})">ë³µì‚¬</button></td><td class="editable" onclick="editCell(${originalIdx}, 'order', this)">${item.order}</td><td class="editable" onclick="editCell(${originalIdx}, 'vendor', this)">${item.vendor}</td><td class="editable" onclick="editCell(${originalIdx}, 'item', this)">${item.item}</td><td class="editable" onclick="editCell(${originalIdx}, 'targetQty', this)">${item.targetQty}</td><td class="editable" onclick="editCell(${originalIdx}, 'inQty', this)" style="color:var(--primary); font-weight:bold;">${item.inQty}</td><td style="color:var(--warn); font-weight:bold;">${rem > 0 ? rem : '-'}</td><td>${isDelayed ? '<span class="status-delay">âš ï¸ ì§€ì—°</span>' : ''}<span class="status-badge ${statusClass}">${statusText}</span></td><td class="editable" onclick="editCell(${originalIdx}, 'remark', this)">${item.remark || '-'}</td><td><button class="btn btn-delete" onclick="deleteItem(${originalIdx})">ì‚­ì œ</button></td></tr>`;
            }
        });
    }

    async function deleteItem(idx) { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { inventory.splice(idx, 1); await saveData(); } }
    function exportCSV() {
        let csv = "\uFEFFë“±ë¡ì¼ì,í”„ë¡œì íŠ¸,ë°œì£¼ë²ˆí˜¸,ì—…ì²´ëª…,ìì¬ëª…,í•„ìš”ìˆ˜ëŸ‰,ì…ê³ ìˆ˜ëŸ‰,ì”ì—¬,ìƒíƒœ,ë¹„ê³ \n";
        inventory.forEach(item => { const rem = item.targetQty - item.inQty; csv += `"${item.regDate}","${item.project}","${item.order}","${item.vendor}","${item.item}",${item.targetQty},${item.inQty},${rem},"${item.inQty===0?'ë¯¸ì…ê³ ':(rem>0?'ë¶€ë¶„':'ì™„ë£Œ')}","${item.remark}"\n`; });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `í˜„í™©_${new Date().toISOString().slice(0,10)}.csv`; a.click();
    }
    loadData(); setInterval(loadData, 15000);
</script>
</body>
</html>
