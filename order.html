<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>SKE-0001 PDF ë„ë©´ ìì¬ ì¶”ì¶œ & ë°œì£¼ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .drop-area { border: 3px dashed #cbd5e1; border-radius: 16px; background-color: #f8fafc; transition: all 0.2s ease-in-out; }
        .drop-area.hover { border-color: #3b82f6; background-color: #eff6ff; }
        input[type="text"], input[type="number"], select {
            border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.75rem 1rem;
            background-color: white; color: #1e293b;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); outline: none;
        }
    </style>
</head>
<body class="p-6 text-slate-800">

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-8 pb-6 border-b-2 border-slate-200">
            <div>
                <h2 class="text-2xl font-bold text-red-700 border-l-8 border-red-700 pl-4 uppercase">SKE-0001 PDF BOM EXTRACTOR</h2>
                <p class="text-slate-500 text-sm mt-1">ë„ë©´ PDFë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìì¬ ë¦¬ìŠ¤íŠ¸ë¥¼ ìë™ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤.</p>
            </div>
            <a href="index.html" class="px-5 py-2 bg-white hover:bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold transition-all shadow-sm">â† ë©”ì¸ í˜„í™©íŒ</a>
        </header>

        <div class="card p-8 mb-8 drop-area text-center" id="drop-area">
            <input type="file" id="fileInput" accept="application/pdf" class="hidden">
            <p class="text-xl font-bold text-slate-700 mb-2">ì—¬ê¸°ì— PDF ë„ë©´ì„ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”</p>
            <p class="text-sm text-slate-500">ë˜ëŠ” <button onclick="document.getElementById('fileInput').click()" class="text-blue-600 hover:underline font-medium">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</button></p>
            <p class="text-xs text-slate-400 mt-4">(.pdf í™•ì¥ì íŒŒì¼ë§Œ ê°€ëŠ¥, í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ëŠ” PDF ë„ë©´ë§Œ ì¶”ì¶œë©ë‹ˆë‹¤)</p>
        </div>

        <main id="extracted-data-area" class="hidden">
            <div class="card overflow-hidden border-t-4 border-red-600 mb-8">
                <div class="bg-red-50 p-6 border-b border-red-200 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-red-800" id="pdfFileName">PDF ë„ë©´ëª…</h3>
                    <div class="flex items-center gap-4">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-widest">í”„ë¡œì íŠ¸ëª…</label>
                        <input type="text" id="projectNameInput" class="w-48 text-sm">
                    </div>
                </div>

                <div class="p-8">
                    <h4 class="text-sm font-bold text-slate-500 mb-4 uppercase tracking-widest">ì¶”ì¶œëœ ìì¬ ë¦¬ìŠ¤íŠ¸ (ìˆ˜ì • ê°€ëŠ¥)</h4>
                    <div class="border border-slate-100 rounded-lg overflow-hidden bg-white shadow-inner mb-6">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 border-b border-slate-100 text-slate-500 font-bold">
                                <tr>
                                    <th class="p-3 w-10">#</th>
                                    <th class="p-3">ìì¬ëª…</th>
                                    <th class="p-3 w-32">ìˆ˜ëŸ‰</th>
                                    <th class="p-3 w-20 text-center">ë‹¨ìœ„</th>
                                    <th class="p-3 w-20 text-center">ì‚­ì œ</th>
                                </tr>
                            </thead>
                            <tbody id="bomTableBody" class="divide-y divide-slate-100">
                                <tr><td colspan="5" class="p-6 text-center text-slate-400">PDF íŒŒì¼ì—ì„œ ìì¬ ì •ë³´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <button onclick="addRow()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-2 px-4 rounded-lg text-xs transition-all">
                        + ìì¬ í–‰ ì¶”ê°€
                    </button>
                </div>
            </div>

            <div class="flex gap-4">
                <button onclick="generateOrderForm()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-black py-4 rounded-xl shadow-lg transition-all transform hover:-translate-y-1">
                    ì´ ë¦¬ìŠ¤íŠ¸ë¡œ ë°œì£¼ì„œ PDF ìƒì„±
                </button>
                 <button onclick="saveExtractedDataToDB()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-xl shadow-lg transition-all transform hover:-translate-y-1">
                    ì¶”ì¶œ ë°ì´í„° DBì— ì €ì¥
                </button>
            </div>
        </main>
    </div>

    <div id="pdf-container" class="hidden">
        <div id="pdf-content" class="p-16 bg-white text-black text-base">
            <h1 class="text-center text-4xl font-bold mb-16 underline underline-offset-8 decoration-2 text-gray-900">ë¬¼ í’ˆ ë°œ ì£¼ ì„œ</h1>
            <div class="flex justify-between mb-12 text-lg">
                <div class="space-y-2">
                    <p><strong>ë°œì‹ :</strong> (ì£¼)SKE</p>
                    <p><strong>ìˆ˜ì‹ :</strong> <span id="pdf-to-vendor" class="border-b border-black px-4 font-bold"></span> ê·€í•˜</p>
                </div>
                <div class="text-right">
                    <p><strong>ì¼ì:</strong> <span id="pdf-date-output"></span></p>
                    <p><strong>í”„ë¡œì íŠ¸ëª…:</strong> <span id="pdf-project-name-output"></span></p>
                </div>
            </div>
            <table class="w-full border-collapse border-2 border-black">
                <thead><tr class="bg-gray-100"><th class="border border-black p-3 text-left">ìì¬ëª… (í’ˆë²ˆ/ê·œê²©)</th><th class="border border-black p-3 w-32">ìˆ˜ëŸ‰</th><th class="border border-black p-3 w-24">ë‹¨ìœ„</th></tr></thead>
                <tbody id="pdf-bom-body"></tbody>
            </table>
            <p class="text-center text-2xl mt-32 font-bold italic tracking-tighter text-gray-800">ìœ„ì™€ ê°™ì´ ë¬¼í’ˆì„ ì •íˆ ë°œì£¼í•©ë‹ˆë‹¤.</p>
            <p class="text-right text-xl mt-16 font-bold text-gray-900">(ì£¼) S K E  ê´€ë¦¬ì (ì¸)</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getDatabase, ref, set, push, child } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";

        // âœ… ê¸°ì¡´ SKE-0001 Firebase ì„¤ì •ê°’ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.
        // ì´ ë¶€ë¶„ì€ ê¸°ì¡´ index.htmlì—ì„œ ë³µì‚¬í•´ì˜¤ì…”ì•¼ í•©ë‹ˆë‹¤.
        const firebaseConfig = {
            databaseURL: "https://ske-0001-default-rtdb.firebaseio.com/", // ê¸°ì¡´ ì£¼ì†Œ
            projectId: "ske-0001", // ê¸°ì¡´ í”„ë¡œì íŠ¸ ID
            // apiKey: "YOUR_API_KEY" // ë§Œì•½ ê¸°ì¡´ index.htmlì— apiKeyê°€ ìˆì—ˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€í•´ì£¼ì„¸ìš”.
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentExtractedBOM = []; // í˜„ì¬ ì¶”ì¶œëœ BOM ë¦¬ìŠ¤íŠ¸
        let currentPdfFileName = ''; // í˜„ì¬ PDF íŒŒì¼ ì´ë¦„

        // --- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('hover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('hover'), false);
        });

        dropArea.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files), false);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        async function handleFiles(files) {
            if (files.length === 0) return;
            const file = files[0];
            if (file.type !== 'application/pdf') {
                alert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            document.getElementById('extracted-data-area').classList.add('hidden');
            currentPdfFileName = file.name;
            document.getElementById('pdfFileName').innerText = file.name;
            document.getElementById('projectNameInput').value = file.name.replace(/\.pdf$/i, ''); // íŒŒì¼ëª…ìœ¼ë¡œ í”„ë¡œì íŠ¸ëª… ì´ˆê¸° ì„¤ì •

            // PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹œì‘
            document.getElementById('bomTableBody').innerHTML = '<tr><td colspan="5" class="p-6 text-center text-blue-500 animate-pulse">PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘... (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”)</td></tr>';
            
            await extractTextFromPDF(file);
            document.getElementById('extracted-data-area').classList.remove('hidden');
        }

        // --- PDF.jsë¥¼ ì‚¬ìš©í•˜ì—¬ PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ ---
        async function extractTextFromPDF(file) {
            const reader = new FileReader();
            reader.onload = async function() {
                const typedarray = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument({data: typedarray}).promise;
                let fullText = "";

                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(s => s.str).join(' ');
                }
                
                // ì—¬ê¸°ì„œ ì¶”ì¶œëœ fullTextë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìì¬ ì •ë³´ë¥¼ íŒŒì‹±í•©ë‹ˆë‹¤.
                // ì´ ë¶€ë¶„ì€ ë„ë©´ ì–‘ì‹ì— ë”°ë¼ 'ê·œì¹™'ì„ í•™ìŠµì‹œì¼œì•¼ í•˜ëŠ” í•µì‹¬ ë¡œì§ì…ë‹ˆë‹¤.
                // í˜„ì¬ëŠ” ê°„ë‹¨í•œ ì˜ˆì‹œë¡œ ìˆ«ì + í…ìŠ¤íŠ¸ íŒ¨í„´ì„ ì°¾ì•„ë´…ë‹ˆë‹¤.
                parseBOM(fullText);
            };
            reader.readAsArrayBuffer(file);
        }

        // --- ì¶”ì¶œëœ í…ìŠ¤íŠ¸ì—ì„œ ìì¬ ë¦¬ìŠ¤íŠ¸ íŒŒì‹± (ì´ ë¶€ë¶„ì´ ê°€ì¥ ì¤‘ìš”í•˜ë©°, ê³ ë„í™” í•„ìš”) ---
        function parseBOM(text) {
            currentExtractedBOM = [];
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            // ì„ì‹œ íŒŒì‹± ë¡œì§: 'ìˆ«ì + ê³µë°± + í…ìŠ¤íŠ¸' íŒ¨í„´ì„ ì°¾ì•„ ìì¬ë¡œ ê°„ì£¼
            // ì‹¤ì œ ë„ë©´ íŒ¨í„´ì— ë§ê²Œ ì •êµí•˜ê²Œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
            // ì˜ˆ: "10 CABLE-ASSY-001" ë˜ëŠ” "5 HOUSING-CONNECTOR"
            const partRegex = /(\d+)\s+([A-Za-z0-9\-_\s\.\/]+)/g; // ìˆ˜ëŸ‰ + ê³µë°± + ìì¬ëª… (ì˜ìˆ«ì, í•˜ì´í”ˆ, ë°‘ì¤„, ê³µë°±, ì , ìŠ¬ë˜ì‹œ í¬í•¨)
            
            let match;
            const foundParts = new Map(); // ì¤‘ë³µ ìì¬ ì²˜ë¦¬ìš© Map

            for (const line of lines) {
                while ((match = partRegex.exec(line)) !== null) {
                    const qty = parseInt(match[1]);
                    const partName = match[2].trim();

                    if (partName.length > 3 && qty > 0) { // ë„ˆë¬´ ì§§ì€ ìì¬ëª…ì´ë‚˜ ìˆ˜ëŸ‰ì´ 0ì¸ ê²ƒì€ ì œì™¸
                        // ì´ë¯¸ ìˆëŠ” ìì¬ë¼ë©´ ìˆ˜ëŸ‰ë§Œ í•©ì‚°
                        if (foundParts.has(partName)) {
                            foundParts.set(partName, foundParts.get(partName) + qty);
                        } else {
                            foundParts.set(partName, qty);
                        }
                    }
                }
            }
            
            // Mapì„ ë°°ì—´ë¡œ ë³€í™˜
            let itemIndex = 1;
            foundParts.forEach((qty, partName) => {
                currentExtractedBOM.push({
                    id: itemIndex++, // ê³ ìœ  ID ë¶€ì—¬
                    partName: partName,
                    qty: qty,
                    unit: 'ea' // ê¸°ë³¸ ë‹¨ìœ„ ì„¤ì •
                });
            });

            renderBOMTable();
        }

        // --- BOM í…Œì´ë¸” UI ë Œë”ë§ ---
        function renderBOMTable() {
            const body = document.getElementById('bomTableBody');
            body.innerHTML = '';
            if (currentExtractedBOM.length === 0) {
                body.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-slate-400">ì¶”ì¶œëœ ìì¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì§ì ‘ ì¶”ê°€í•˜ê±°ë‚˜ ë‹¤ë¥¸ PDFë¥¼ ì‹œë„í•´ ë³´ì„¸ìš”.</td></tr>';
                return;
            }

            currentExtractedBOM.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3 text-center text-slate-500">${index + 1}</td>
                    <td class="p-3">
                        <input type="text" value="${item.partName}" class="w-full text-sm border-none bg-transparent focus:bg-white p-1 rounded" onchange="updateItem(${item.id}, 'partName', this.value)">
                    </td>
                    <td class="p-3">
                        <input type="number" value="${item.qty}" class="w-24 text-sm text-right border-none bg-transparent focus:bg-white p-1 rounded" onchange="updateItem(${item.id}, 'qty', parseInt(this.value))">
                    </td>
                    <td class="p-3 text-center">
                         <input type="text" value="${item.unit}" class="w-16 text-sm text-center border-none bg-transparent focus:bg-white p-1 rounded" onchange="updateItem(${item.id}, 'unit', this.value)">
                    </td>
                    <td class="p-3 text-center">
                        <button onclick="deleteItem(${item.id})" class="text-red-500 hover:text-red-700 text-xs font-bold transition-all">ì‚­ì œ</button>
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        // --- BOM ë°ì´í„° ìˆ˜ì • í•¨ìˆ˜ ---
        function updateItem(id, field, value) {
            const item = currentExtractedBOM.find(i => i.id === id);
            if (item) {
                item[field] = value;
            }
        }

        // --- BOM í–‰ ì¶”ê°€ í•¨ìˆ˜ ---
        window.addRow = function() {
            const newItemId = currentExtractedBOM.length > 0 ? Math.max(...currentExtractedBOM.map(item => item.id)) + 1 : 1;
            currentExtractedBOM.push({
                id: newItemId,
                partName: '',
                qty: 1,
                unit: 'ea'
            });
            renderBOMTable();
        }

        // --- BOM í–‰ ì‚­ì œ í•¨ìˆ˜ ---
        window.deleteItem = function(id) {
            currentExtractedBOM = currentExtractedBOM.filter(item => item.id !== id);
            renderBOMTable();
        }

        // --- ë°œì£¼ì„œ PDF ìƒì„± í•¨ìˆ˜ ---
        window.generateOrderForm = function() {
            if (currentExtractedBOM.length === 0) {
                alert("ì¶”ì¶œëœ ìì¬ ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            const projectName = document.getElementById('projectNameInput').value || currentPdfFileName.replace(/\.pdf$/i, ' (í”„ë¡œì íŠ¸)');
            const orderTitle = projectName + `_ë°œì£¼_${new Date().toLocaleDateString()}`;

            document.getElementById('pdf-date-output').innerText = new Date().toLocaleDateString();
            document.getElementById('pdf-project-name-output').innerText = projectName;
            document.getElementById('pdf-to-vendor').innerText = "ì—…ì²´ëª… ì…ë ¥"; // ì‚¬ìš©ì ì…ë ¥ í•„ë“œ í•„ìš”

            const pdfBomBody = document.getElementById('pdf-bom-body');
            pdfBomBody.innerHTML = '';
            currentExtractedBOM.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <tr>
                        <td class="border border-black p-3 text-left font-medium">${item.partName}</td>
                        <td class="border border-black p-3 text-right font-bold">${item.qty}</td>
                        <td class="border border-black p-3 text-center">${item.unit}</td>
                    </tr>
                `;
                pdfBomBody.appendChild(tr);
            });

            html2pdf().from(document.getElementById('pdf-content')).set({
                margin: 10,
                filename: `${orderTitle}.pdf`,
                jsPDF: { format: 'a4', orientation: 'portrait' }
            }).save();
        };

        // --- ì¶”ì¶œëœ ë°ì´í„°ë¥¼ Firebase DBì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜ ---
        window.saveExtractedDataToDB = async function() {
            if (currentExtractedBOM.length === 0) {
                alert("ì €ì¥í•  ìì¬ ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const projectName = document.getElementById('projectNameInput').value || currentPdfFileName.replace(/\.pdf$/i, ' (í”„ë¡œì íŠ¸)');
            
            // Firebase Realtime Databaseì˜ 'projects' ë…¸ë“œ ì•„ë˜ì— ìƒˆ í”„ë¡œì íŠ¸ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
            // ì´ë ‡ê²Œ ì €ì¥í•˜ë©´ ê¸°ì¡´ 'index.html'ì˜ í˜„í™©íŒì—ë„ ì—°ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            try {
                const newProjectRef = push(child(ref(db), 'projects')); // 'projects' ë…¸ë“œ ì•„ë˜ì— ìƒˆ í‚¤ ìƒì„±
                await set(newProjectRef, {
                    projectName: projectName,
                    customerName: 'ì¶”ì¶œëœ ë„ë©´', // ê¸°ë³¸ê°’, í•„ìš”ì‹œ ìˆ˜ì •
                    bom: currentExtractedBOM, // ì¶”ì¶œëœ ìì¬ ë¦¬ìŠ¤íŠ¸
                    createdAt: Date.now()
                });
                alert('âœ… ì¶”ì¶œëœ ìì¬ ë¦¬ìŠ¤íŠ¸ê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error("Firebase ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:", error);
                alert('ğŸ”´ ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ì„¤ì • ë˜ëŠ” ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.');
            }
        };

    </script>
</body>
</html>
